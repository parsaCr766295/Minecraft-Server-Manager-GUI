# راهنمای استفاده از وب‌سوکت در Minecraft Server Manager

این راهنما نحوه استفاده از قابلیت وب‌سوکت اضافه شده به Minecraft Server Manager را توضیح می‌دهد.

## مقدمه

وب‌سوکت یک پروتکل ارتباطی دوطرفه است که امکان ارتباط زنده بین مرورگر و سرور را فراهم می‌کند. با استفاده از وب‌سوکت، می‌توانید به‌روزرسانی‌های زنده از وضعیت سرور ماینکرفت دریافت کنید.

## پورت‌های استفاده شده

- **Flask Web Server**: پورت 5000
- **WebSocket Server**: پورت 8765 (یا پورت بعدی در دسترس)

## نحوه اتصال به وب‌سوکت

وقتی رابط وب پایتون را اجرا می‌کنید، سرور وب‌سوکت به طور خودکار راه‌اندازی می‌شود. اگر پورت 8765 در دسترس نباشد، سیستم به طور خودکار پورت بعدی در دسترس را انتخاب می‌کند. می‌توانید با استفاده از JavaScript به این سرور متصل شوید:

```javascript
// روش 1: استفاده از پورت ارسال شده از سرور (توصیه شده)
const socket = new WebSocket('ws://' + window.location.hostname + ':' + wsPort);

// روش 2: استفاده از API برای دریافت اطلاعات وب‌سوکت
async function connectWebSocket() {
  const response = await fetch('/api/websocket-info');
  const data = await response.json();
  const socket = new WebSocket(`ws://${data.host}:${data.port}`);
  return socket;
}

// اتصال باز شد
socket.addEventListener('open', (event) => {
  console.log('اتصال وب‌سوکت برقرار شد');
});

// گوش دادن به پیام‌ها
socket.addEventListener('message', (event) => {
  const data = JSON.parse(event.data);
  console.log('پیام دریافت شد:', data);
});

// اتصال بسته شد
socket.addEventListener('close', (event) => {
  console.log('اتصال وب‌سوکت بسته شد');
});

// خطای اتصال
socket.addEventListener('error', (event) => {
  console.error('خطای وب‌سوکت:', event);
});
```

## انواع پیام‌های وب‌سوکت

سرور وب‌سوکت انواع مختلفی از پیام‌ها را ارسال می‌کند:

### 1. پیشرفت راه‌اندازی

```json
{
  "type": "progress",
  "message": "در حال دانلود server.jar...",
  "percent": 40
}
```

### 2. موفقیت راه‌اندازی

```json
{
  "type": "success",
  "message": "راه‌اندازی کامل شد!",
  "percent": 100
}
```

### 3. خطای راه‌اندازی

```json
{
  "type": "error",
  "message": "خطا در دانلود فایل",
  "percent": 0
}
```

### 4. لاگ‌های سرور

```json
{
  "type": "log",
  "data": {
    "log": "[12:34:56] [Server thread/INFO]: Starting minecraft server version 1.19.2"
  }
}
```

### 5. وضعیت سرور

```json
{
  "type": "server_status",
  "status": "started",
  "pid": 1234
}
```

## ارسال پیام به سرور

می‌توانید پیام‌هایی را به سرور وب‌سوکت ارسال کنید:

```javascript
// ارسال پیام به سرور
const message = {
  "type": "command",
  "command": "status"
};
socket.send(JSON.stringify(message));
```

## نکات مهم

1. اطمینان حاصل کنید که پکیج `websockets` نصب شده باشد:
   ```
   pip install websockets
   ```

2. اگر از EXE استفاده می‌کنید، مطمئن شوید که پورت‌های مورد نیاز در فایروال سیستم باز است.

3. برای اتصال از راه دور، به جای `localhost` از آدرس IP سرور استفاده کنید.

4. در صورت قطع اتصال، صفحه وب به طور خودکار سعی می‌کند دوباره متصل شود.

5. اگر پورت 8765 در دسترس نباشد، سیستم به طور خودکار پورت بعدی در دسترس را انتخاب می‌کند. برای اطمینان از اتصال به پورت صحیح، از API `/api/websocket-info` استفاده کنید.

## عیب‌یابی

- **مشکل اتصال**: مطمئن شوید که سرور وب‌سوکت در حال اجراست و پورت مورد نظر در دسترس است. از دکمه "Auto-detect" در صفحه تست وب‌سوکت برای یافتن پورت صحیح استفاده کنید.
- **عدم دریافت پیام**: کنسول مرورگر را برای خطاهای احتمالی بررسی کنید.
- **خطای CORS**: اگر از دامنه دیگری به وب‌سوکت متصل می‌شوید، ممکن است با خطای CORS مواجه شوید.
- **خطای پورت در حال استفاده**: اگر با خطای "Address already in use" مواجه شدید، سیستم به طور خودکار پورت بعدی را امتحان می‌کند. اگر پس از چندین تلاش همچنان با خطا مواجه هستید، سرورهای در حال اجرا را بررسی و در صورت نیاز متوقف کنید.